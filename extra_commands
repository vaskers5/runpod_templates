bash -c '
set -e

# --- Часть 1: Первоначальная настройка (выполняется только один раз) ---
if [ ! -f /opt/runpod_setup_complete ]; then
    echo "--- Выполняется первоначальная настройка контейнера ---"

    # 1. Установка зависимостей
    echo "Установка зависимостей..."
    apt-get update && apt-get install -y --no-install-recommends \
        openssh-server sudo git ca-certificates nano wget \
        && rm -rf /var/lib/apt/lists/*

    # 2. Установка или обновление Miniconda
    echo "Установка/обновление Miniconda в /opt/conda..."
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -u -p /opt/conda
    rm /tmp/miniconda.sh
    ln -sf /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh

    # 3. Клонирование репозитория со скриптами
    if [ -z "$GITHUB_TOKEN" ]; then
        echo "Ошибка: GITHUB_TOKEN не задан." && exit 1
    fi
    echo "Клонирование репозитория со скриптами..."
    rm -rf /opt/scripts
    git clone "https://github.com/vaskers5/runpod_templates" /opt/scripts
    chmod +x /opt/scripts/*.sh
    rm -rf /opt/scripts/.git
    bash /opt/scripts/bootstrap.sh            # поправил путь, чтобы совпадал с git clone

    touch /opt/runpod_setup_complete          # помечаем, что настройка выполнена
fi
'
