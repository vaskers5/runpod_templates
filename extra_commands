bash -c '
set -e

# --- Часть 1: Первоначальная настройка (выполняется только один раз) ---
if [ ! -f /opt/runpod_setup_complete ]; then
    echo "--- Выполняется первоначальная настройка контейнера ---"

    # 1. Обновление пакетов и установка зависимостей
    echo "Установка openssh-server, sudo, git..."
    apt-get update && apt-get install -y --no-install-recommends \
        openssh-server \
        sudo \
        git \
        ca-certificates \
        nano \
        && rm -rf /var/lib/apt/lists/*

    # 2. Клонирование репозитория со скриптами с использованием токена
    if [ -z "$GITHUB_TOKEN" ]; then
        echo "Ошибка: Переменная окружения GITHUB_TOKEN не задана. Невозможно клонировать приватный репозиторий."
        exit 1
    fi
    echo "Клонирование репозитория со скриптами..."
    git clone "https://github.com/vaskers5/runpod_templates" /opt/scripts
    chmod +x /opt/scripts/create_user.sh
    rm -rf /opt/scripts/.git

    # 3. Предварительная настройка SSH-сервера
    echo "Настройка конфигурации SSH..."
    mkdir -p /var/run/sshd
    sed -i "s/^#?PermitRootLogin.*/PermitRootLogin no/" /etc/ssh/sshd_config
    sed -i "s/^#?PasswordAuthentication.*/PasswordAuthentication no/" /etc/ssh/sshd_config
    sed -i "s/^#?PubkeyAuthentication.*/PubkeyAuthentication yes/" /etc/ssh/sshd_config
    sed -i "s/^#?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/" /etc/ssh/sshd_config
    sed -i "s/^#?UsePAM.*/UsePAM yes/" /etc/ssh/sshd_config

    # 4. Создаем файл-флаг
    touch /opt/runpod_setup_complete
    echo "--- Первоначальная настройка завершена ---"
else
    echo "--- Первоначальная настройка уже выполнена, пропускается. ---"
fi

# --- Часть 2: Запуск сервисов и создание пользователя (выполняется всегда) ---

# 1. Запуск SSH сервера
echo "Запуск SSH сервера..."
/usr/sbin/sshd -D &

# 2. Создание пользователя
echo "Проверка переменных для создания пользователя..."
if [ -n "$ADMIN_USER_NAME" ] && [ -n "$ADMIN_USER_PUBKEY" ]; then
    echo "Создание пользователя $ADMIN_USER_NAME..."
    KEY_FILE=$(mktemp)
    echo "$ADMIN_USER_PUBKEY" > "$KEY_FILE"
    
    SUDO_ARG=""
    if [ "$ADMIN_USER_SUDO" = "true" ]; then
      SUDO_ARG="--sudo"
    fi
    
    /opt/scripts/create_user.sh "$ADMIN_USER_NAME" "$KEY_FILE" $SUDO_ARG "pod_ip_or_domain"
    
    rm "$KEY_FILE"
    echo "Пользователь $ADMIN_USER_NAME успешно настроен."
else
    echo "Переменные ADMIN_USER_NAME и ADMIN_USER_PUBKEY не заданы. Пользователь не создан."
fi

echo "--- Контейнер готов к работе. Ожидание подключения... ---"
sleep infinity
'